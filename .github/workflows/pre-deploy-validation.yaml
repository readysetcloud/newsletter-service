name: Pre-deployment validations

on:
  workflow_call:

jobs:
  eslint:
    name: Lint JS
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Configure NPM
        run: |
          npm ci
          npm run lint

  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Unit Tests
        run: |
          npm ci
          npm run coverage

  rust-tests:
    name: Run Rust Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Tests
        run: |
          cargo test --manifest-path functions/admin-rust/Cargo.toml
          cargo test --manifest-path functions/auth-rust/cognito-post-confirmation/Cargo.toml
          cargo test --manifest-path functions/auth-rust/cognito-pre-token-generation/Cargo.toml
          cargo test --manifest-path functions/auth-rust/lambda-authorizer/Cargo.toml
          cargo test --manifest-path functions/auth-rust/refresh-momento-token/Cargo.toml

  rust-lint:
    name: Rust Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Rust Format
        run: |
          cargo fmt --manifest-path functions/admin-rust/Cargo.toml --all -- --check
      - name: Rust Clippy
        run: |
          cargo clippy --manifest-path functions/admin-rust/Cargo.toml --all-targets --all-features -- -D warnings
          cargo clippy --manifest-path functions/auth-rust/cognito-post-confirmation/Cargo.toml --all-targets --all-features -- -D warnings
          cargo clippy --manifest-path functions/auth-rust/cognito-pre-token-generation/Cargo.toml --all-targets --all-features -- -D warnings
          cargo clippy --manifest-path functions/auth-rust/lambda-authorizer/Cargo.toml --all-targets --all-features -- -D warnings
          cargo clippy --manifest-path functions/auth-rust/refresh-momento-token/Cargo.toml --all-targets --all-features -- -D warnings
